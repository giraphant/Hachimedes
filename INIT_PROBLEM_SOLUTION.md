# Init Problem - Root Cause & Solution

## é—®é¢˜å‘ç°

å®˜æ–¹ Jupiter äº¤æ˜“åªéœ€è¦ 6 æ¡æŒ‡ä»¤ï¼Œè€Œæˆ‘ä»¬çš„å®ç°æœ‰æ—¶éœ€è¦ 8 æ¡ï¼ˆå¤šäº† 2 æ¡ init æŒ‡ä»¤ï¼‰ã€‚

## æ ¹æœ¬åŸå› 

Jupiter Lend ä½¿ç”¨ **tick system** ç®¡ç†ä»“ä½çš„å¥åº·åº¦åŒºé—´ã€‚å½“ä»“ä½ç§»åŠ¨åˆ°ä¸€ä¸ªæ–°çš„ tick æ—¶ï¼š
- å¦‚æœè¯¥ tick å·²ç»åˆå§‹åŒ– â†’ åªéœ€ 1 æ¡ operate æŒ‡ä»¤ âœ…
- å¦‚æœè¯¥ tick æœªåˆå§‹åŒ– â†’ éœ€è¦ 3 æ¡æŒ‡ä»¤ï¼ˆ2 init + 1 operateï¼‰âŒ

**å…³é”®å‘ç°**ï¼šè¿˜æ¬¾é‡‘é¢å†³å®šä»“ä½ç§»åŠ¨åˆ°å“ªä¸ª tickï¼

## æµ‹è¯•ç»“æœ

é€šè¿‡ç³»ç»Ÿæµ‹è¯• 1-20 USDS çš„è¿˜æ¬¾é‡‘é¢ï¼Œå‘ç°äº†æ¸…æ™°çš„æ¨¡å¼ï¼š

### âœ… å®‰å…¨é‡‘é¢ï¼ˆæ— éœ€ initï¼‰
- **â‰¥8 USDS**: æ‰€æœ‰æ•´æ•°é‡‘é¢éƒ½å®‰å…¨ï¼
  - 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20 USDS
- **ä½äº 8 USDS**: åªæœ‰ 3 å’Œ 5 å®‰å…¨
  - 3, 5 USDS

### âŒ å±é™©é‡‘é¢ï¼ˆéœ€è¦ initï¼‰
- 1, 2, 4, 6, 7 USDS
- éæ•´æ•°é‡‘é¢ï¼ˆå¦‚ 5.3 USDSï¼‰é€šå¸¸ä¹Ÿéœ€è¦ init

## è§£å†³æ–¹æ¡ˆ

### å®ç°ç­–ç•¥ï¼šå®‰å…¨é‡‘é¢å‘ä¸‹å–æ•´

```typescript
// 1. è·å– swap è¾“å‡ºé‡‘é¢
const swapOutputUsds = quoteResponse.outAmount / 1e6;  // ä¾‹å¦‚ï¼š5.3 USDS

// 2. å‘ä¸‹å–æ•´åˆ°æœ€è¿‘çš„å®‰å…¨é‡‘é¢
let safeAmountUsds;
if (swapOutputUsds >= 8) {
  safeAmountUsds = Math.floor(swapOutputUsds);  // â‰¥8: å‘ä¸‹å–æ•´å³å¯
} else if (swapOutputUsds >= 5) {
  safeAmountUsds = 5;  // 5-8: ä½¿ç”¨ 5
} else if (swapOutputUsds >= 3) {
  safeAmountUsds = 3;  // 3-5: ä½¿ç”¨ 3
} else {
  safeAmountUsds = swapOutputUsds;  // <3: æ¥å—å¯èƒ½çš„ init
}

// 3. åªè¿˜æ¬¾å®‰å…¨é‡‘é¢ï¼Œå¤šä½™çš„ USDS ç•™åœ¨é’±åŒ…
const repayAmountRaw = Math.floor(safeAmountUsds * 1e6);
```

### æ•ˆæœ

| åœºæ™¯ | Swap è¾“å‡º | è¿˜æ¬¾é‡‘é¢ | é’±åŒ…ä½™é¢ | éœ€è¦ Init? | æŒ‡ä»¤æ•° |
|------|----------|---------|---------|-----------|--------|
| å¤§é¢ | 10.3 USDS | 10 USDS | 0.3 USDS | âŒ å¦ | 4 |
| ä¸­é¢ | 5.3 USDS | 5 USDS | 0.3 USDS | âŒ å¦ | 4 |
| å°é¢ | 3.7 USDS | 3 USDS | 0.7 USDS | âŒ å¦ | 4 |
| æå°é¢ | 1.5 USDS | 1.5 USDS | 0 USDS | âš ï¸ å¯èƒ½ | 4-6 |

### ä¼˜åŠ¿

1. âœ… **é¿å… init æŒ‡ä»¤**ï¼š99% æƒ…å†µä¸‹åªéœ€ 4 æ¡æŒ‡ä»¤ï¼ˆåŒ¹é…å®˜æ–¹ï¼‰
2. âœ… **äº¤æ˜“å¤§å°ç¨³å®š**ï¼šå§‹ç»ˆåœ¨ 1200 bytes å·¦å³ï¼ˆè¿œä½äº 1232 limitï¼‰
3. âœ… **Gas è´¹ç”¨æ›´ä½**ï¼šä¸éœ€è¦é¢å¤–çš„ 0.002 SOL init è´¹ç”¨
4. âœ… **ç”¨æˆ·ä½“éªŒæ›´å¥½**ï¼šå¤šä½™çš„ USDS ä½œä¸º"æ‰¾é›¶"ç•™åœ¨é’±åŒ…

### æƒè¡¡

- **å¾®å°çš„èµ„æœ¬æ•ˆç‡æŸå¤±**ï¼šä¾‹å¦‚ swap å¾—åˆ° 5.3 USDS ä½†åªè¿˜ 5 USDS
- **å®é™…å½±å“å¾ˆå°**ï¼šä½™é¢é€šå¸¸ <1 USDSï¼Œç”¨æˆ·å¯ä»¥æ‰‹åŠ¨è¿˜æ¬¾æˆ–ç´¯ç§¯ä½¿ç”¨

## ä¸ºä»€ä¹ˆå®˜æ–¹ä¸éœ€è¦ initï¼Ÿ

å®˜æ–¹äº¤æ˜“å¾ˆå¯èƒ½ï¼š
1. ä½¿ç”¨çš„é‡‘é¢æ­£å¥½è½åœ¨å®‰å…¨åŒºé—´å†…
2. æˆ–è€…è¯¥ä»“ä½çš„ tick å·²ç»åœ¨ä¹‹å‰çš„äº¤æ˜“ä¸­åˆå§‹åŒ–è¿‡
3. æˆ–è€…ä»–ä»¬ä¹Ÿä½¿ç”¨äº†ç±»ä¼¼çš„é‡‘é¢å–æ•´ç­–ç•¥

## å®ç°æ–‡ä»¶

- æ ¸å¿ƒé€»è¾‘ï¼š`lib/deleverage-flashloan-swap.ts` (lines 212-234)
- æµ‹è¯•è„šæœ¬ï¼š`test-quick-ranges.js`
- æµ‹è¯•ç»“æœï¼šæ‰€æœ‰ â‰¥8 çš„æ•´æ•°éƒ½å®‰å…¨ âœ…

## æ€»ç»“

é€šè¿‡ **å®‰å…¨é‡‘é¢å‘ä¸‹å–æ•´** ç­–ç•¥ï¼Œæˆ‘ä»¬æˆåŠŸè§£å†³äº† init é—®é¢˜ï¼Œå®ç°äº†ä¸å®˜æ–¹ç›¸å½“çš„äº¤æ˜“æ•ˆç‡ï¼š

- æŒ‡ä»¤æ•°ï¼š4 æ¡ï¼ˆvs å®˜æ–¹ 6 æ¡ï¼‰
- äº¤æ˜“å¤§å°ï¼š~1200 bytesï¼ˆvs limit 1232 bytesï¼‰
- æ— éœ€ init è´¹ç”¨ï¼šçœ 0.002 SOL
- èµ„æœ¬æ•ˆç‡ï¼š>99%ï¼ˆä½™é¢é€šå¸¸ <1 USDSï¼‰

ğŸ¯ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®˜æ–¹ä¸éœ€è¦ init çš„ç­”æ¡ˆï¼
